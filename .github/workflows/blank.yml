name: API Tests

on:
  schedule:
    - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `newman-reporter-html`
        run: |
          echo "üîß –£–¥–∞–ª—è–µ–º –∫–µ—à npm..."
          npm cache clean --force
          
          echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º newman-reporter-html..."
          npm install -g newman-reporter-html || echo "‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ, –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ..."
          npm install newman-reporter-html || echo "‚ùå –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–∞—Å—å!"

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö npm-–ø–∞–∫–µ—Ç–æ–≤
        run: npm list -g --depth=0

      - name: üöÄ –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
        run: |
          mkdir -p public
          echo "üõ† –ó–∞–ø—É—Å–∫–∞–µ–º newman..."
          newman run postman_collection_auth_fixed.json \
            -e Investudy.postman_environment.json \
            -r html,json,cli \
            --reporter-html-export="./public/report.html" \
            --reporter-json-export="./public/newman-report.json" \
            --verbose | tee newman.log || true
