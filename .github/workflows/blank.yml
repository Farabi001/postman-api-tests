name: Run API Tests  # –ù–∞–∑–≤–∞–Ω–∏–µ workflow

on:
  schedule:
    - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (–≤ 00:00 UTC)
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  test:
    runs-on: ubuntu-latest  # –ó–∞–ø—É—Å–∫ –Ω–∞ Ubuntu

    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Newman –∏ Allure
        run: |
          npm install -g newman newman-reporter-allure allure-commandline
          echo "‚úÖ Newman –∏ Allure —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
          echo "BASE_URL = ${{ secrets.BASE_URL }}"
          echo "USERNAME = ${{ secrets.USERNAME }}"
          echo "PASSWORD = (—Å–∫—Ä—ã—Ç–æ)"
          echo "AUTH_TOKEN = (–µ—Å–ª–∏ –ø—É—Å—Ç–æ, –ª–æ–≥–∏–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)"

      - name: üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: cat postman_environment.json

      - name: üîç –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤
        run: |
          newman run postman_collection_auth_fixed.json \
            --environment postman_environment.json \ 
            --reporters cli,allure \
            --reporter-allure-export allure-results || echo "–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã" > failed_tests.txt

      - name: üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ Allure
        run: |
          allure generate allure-results --clean -o allure-report

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages  # –£–∫–∞–∑—ã–≤–∞–µ–º, –∫—É–¥–∞ –ø—É—à–∏—Ç—å

      - name: üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
        run: |
          MESSAGE="‚úÖ API-—Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!"
          if [ -f failed_tests.txt ]; then MESSAGE="‚ùå API-—Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã!"; fi
          MESSAGE="$MESSAGE%0Aüìä –û—Ç—á–µ—Ç: https://Farabi001.github.io/postman-api-tests/"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE"
