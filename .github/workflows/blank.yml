name: API Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: npm install -g newman newman-reporter-allure

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
        run: ls -l

      - name: üöÄ –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤
        run: |
          newman run postman_collection_auth_fixed.json \
              -e Investudy.postman_environment.json \
              -r cli --verbose

      - name: üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Allure-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        run: ls -la newman-report/allure-results || echo "–ü–∞–ø–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

      - name: üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ Allure
        if: always()
        run: |
          allure generate newman-report/allure-results --clean -o newman-report/allure-report || true

      - name: üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
        run: |
          MESSAGE="‚úÖ API-—Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!"
          if grep -q "‚ùå –û—à–∏–±–∫–∞" newman/*.log; then 
            MESSAGE="‚ùå –û—à–∏–±–∫–∏ –≤ API-—Ç–µ—Å—Ç–∞—Ö!"
            ERRORS=$(grep "‚ùå –û—à–∏–±–∫–∞" newman/*.log | tail -10)
            MESSAGE="$MESSAGE%0A%0A$ERRORS"
          fi
          MESSAGE="$MESSAGE%0A–û—Ç—á–µ—Ç: https://Farabi001.github.io/api-tests/"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE"
