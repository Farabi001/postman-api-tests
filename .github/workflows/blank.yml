name: API Tests

on:
  schedule:
    - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üöÄ –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
        run: |
          mkdir -p public
          echo "üõ† –ó–∞–ø—É—Å–∫–∞–µ–º newman..."
          newman run postman_collection_auth_fixed.json \
            -e Investudy.postman_environment.json \
            -r html,json,cli \
            --reporter-html-export="./public/report.html" \
            --reporter-json-export="./public/newman-report.json" \
            --verbose | tee newman.log || true

      - name: üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ public/
        run: ls -la public/ || echo "‚ùå –ü–∞–ø–∫–∞ public –ø—É—Å—Ç–∞!"

      - name: üì§ –ü—É–±–ª–∏–∫–∞—Ü–∏—è HTML-–æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
        if: always()
        run: |
          if [ -f public/report.html ]; then
            echo "üì§ –ì–æ—Ç–æ–≤–∏–º –≤–µ—Ç–∫—É `gh-pages`..."
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git checkout --orphan gh-pages
            git reset --hard
            git clean -fdx
            cp -r public/* .
            git add .
            git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω HTML-–æ—Ç—á–µ—Ç"
            git push origin HEAD:gh-pages --force || echo "‚ùå –û—à–∏–±–∫–∞ `git push`!"
          else
            echo "‚ùå –û—Ç—á–µ—Ç report.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `gh-pages`
        run: |
          git fetch origin
          git branch -r | grep gh-pages || echo "‚ùå –í–µ—Ç–∫–∞ `gh-pages` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"

      - name: üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "üîç –î–ª–∏–Ω–∞ TELEGRAM_BOT_TOKEN: ${#TELEGRAM_BOT_TOKEN} —Å–∏–º–≤–æ–ª–æ–≤"
          echo "üîç TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_CHAT_ID –ø—É—Å—Ç–æ–π!"
            exit 1
          fi

          echo "üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram API..."
          RESPONSE=$(curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage?chat_id=$TELEGRAM_CHAT_ID&text=TestMessage")
          echo "üì° –û—Ç–≤–µ—Ç Telegram: $RESPONSE"

      - name: üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID –ø—É—Å—Ç—ã–µ!"
            exit 1
          fi

          if [ -f public/newman-report.json ]; then
            ERRORS=$(jq '[.run.executions[] | select(.assertions[]?.error)] | length' public/newman-report.json)
            MESSAGE="‚úÖ API-—Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫: $ERRORS"
          else
            MESSAGE="‚ùå –û—à–∏–±–∫–∞: JSON-–æ—Ç—á–µ—Ç newman-report.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          fi

          MESSAGE="$MESSAGE%0A–û—Ç—á–µ—Ç: https://Farabi001.github.io/api-tests/report.html"

          echo "üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ Telegram..."
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=$MESSAGE")

          echo "üì° –û—Ç–≤–µ—Ç Telegram: $RESPONSE"
