name: API Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîç –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤
        run: |
          newman run postman_collection_auth_fixed.json \
            --environment Investudy.postman_environment.json \
            --reporters cli,allure \
            --reporter-allure-export allure-results || touch failed_tests.txt

      - name: üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ Allure (–≤—Å–µ–≥–¥–∞)
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report || true

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ GitHub Pages
        if: always()
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git checkout --orphan gh-pages
          git reset --hard
          git clean -fdx
          
          mkdir -p public
          cp -r allure-report/* public/
          
          git add public
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω –æ—Ç—á–µ—Ç"
          git push origin HEAD:gh-pages --force || true

      - name: üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
        if: always()
        run: |
          if [ -f failed_tests.txt ]; then 
            MESSAGE="‚ùå API-—Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã!"; 
          else 
            MESSAGE="‚úÖ API-—Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!"; 
          fi
          MESSAGE="$MESSAGE%0A–û—Ç—á–µ—Ç: https://Farabi001.github.io/postman-api-tests/"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"
