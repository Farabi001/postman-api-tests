name: API Tests

on:
  schedule:
    - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîß –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ newman –∏ —Ä–µ–ø–æ—Ä—Ç–µ—Ä–æ–≤
        run: |
          echo "üõ† –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π newman –∏ —Ä–µ–ø–æ—Ä—Ç–µ—Ä—ã..."
          npm uninstall -g newman newman-reporter-html newman-reporter-json || true
          npm cache clean --force
          
          echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ..."
          npm install -g newman newman-reporter-html newman-reporter-json

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ–ø–æ—Ä—Ç–µ—Ä–æ–≤
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
          npm list -g --depth=0 | grep "newman" || echo "‚ùå –†–µ–ø–æ—Ä—Ç–µ—Ä—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"

      - name: üîß –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ npm-–ø–∞–∫–µ—Ç–æ–≤
        run: |
          echo "‚ôª –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º npm-–ø–∞–∫–µ—Ç—ã..."
          npm rebuild -g newman newman-reporter-html newman-reporter-json

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–ø–æ—Ä—Ç–µ—Ä–æ–≤
        run: newman -h | grep "reporters" || echo "‚ùå –†–µ–ø–æ—Ä—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"

      - name: üöÄ –ó–∞–ø—É—Å–∫ API-—Ç–µ—Å—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
        run: |
          mkdir -p public
          echo "üõ† –ó–∞–ø—É—Å–∫–∞–µ–º newman..."
          newman run postman_collection_auth_fixed.json \
            -e Investudy.postman_environment.json \
            -r html --reporter-html-export=public/report.html \
            -r json --reporter-json-export=newman-report.json \
            -r cli --verbose | tee newman.log || true

      - name: üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Ç—á–µ—Ç–æ–≤
        run: |
          echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
          ls -la public/ || echo "‚ùå –ü–∞–ø–∫–∞ public –ø—É—Å—Ç–∞!"
          ls -la newman-report.json || echo "‚ùå JSON-–æ—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo "üìÑ –í—ã–≤–æ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 20 —Å—Ç—Ä–æ–∫ newman.log:"
          cat newman.log | tail -20
